# 定子拓扑优化方案（15° 扇区）

## 目标
使用现有的免疫算法（`clonalg.m`）在单个 15° 扇区内优化定子齿/槽拓扑，再将优化后的图案复制 6 次环绕定子。

## 设计域设置
- **扇区范围**：一个 15° 机械扇区，对应 12 槽机的 1/24 圆周；复制 6 次即可形成 90° 周向重复。设计域仅在定子铁轭与齿肩之间，**不包含槽内区域**（槽口到线圈窗口保持冻结）。
- **对称性**：FEMM 可继续用 1/4 或 1/6 周向对称求解，但设计变量仍只放在 15° 扇区，并在几何生成时复制/旋转到对称边界。
- **离散化选项**：
  - **像素/体素网格**：在扇区内建立极坐标（r–θ）网格，仅对“可设计区”单元赋予比特；槽内网格直接标记为不可修改的固定标签（例如铜/空气）。
  - **参数化图元**：用径向/弧向控制线调整铁轭厚度、齿肩外形或桥连形状，槽窗口尺寸与位置保持固定。
  - **混合方案**：铁轭/齿肩使用二值网格，少量连续参数控制桥厚或圆角；总比特长度仍需可控。
- **边界约束**：锁定外径（定子轭外圆）和内侧气隙圆；保证最小齿颈/桥厚、最小铁轭厚度，并保持槽窗口/线圈区不被侵入。

## CLONALG 编码
- **二进制基因**：每个网格单元对应 1 个比特（1 = 铁，0 = 空气/铜/空洞）。例如 20×8（θ×r）网格需要 160 位。若要加入连续参数，可为每个参数预留比特段，用现有 `decode` 方式解码。
- **适应度函数**：重写 `myfunc` 以接收解码出的材料分布/参数并执行：
  1. 根据比特网格/参数重建 15° 扇区 FEMM 几何（如绘制块或删除区域并赋材质）。
  2. 运行 `scantorque`（或快速代理模型）获得平均转矩与脉动。
  3. 施加约束/惩罚（如最小面积、去磁磁密、可制造性），计算标量适应度 `J = -T_avg + λ·T_ripple + μ·penalties`。
- **种群规模**：保持总比特长度可控（<256 位），以便超变异有效且单次评估运行时间可接受。

## FEMM 自动化提示
- 准备一个 **基础模板** FEMM 文件，预先定义线圈、磁体、边界条件和周期扇区引用。
- 在 `femmfunc`（或新辅助函数）中脚本化 **几何重建**：
  - 仅清除设计域内的实体。
  - 按比特网格绘制或删除单元（使用 `mi_drawpolygon`/`mi_addblocklabel` 并赋材质）。
  - 重新划分网格（`mi_createmesh`）并求解。
- 单扇区求解后依赖周期边界；若仅在扇区内积分转矩，报告整机转矩时需按扇区数量进行缩放。

## 对称复制
- 为可视化或最终验证，可将优化后的 15° 扇区绕定子复制 6 次（如需可镜像，形成完整 360°）并在 FEMM 中用旋转复制命令实现。
- 优化循环保持单扇区求解以减少迭代耗时；仅在最终检查时做全模型复制。

## 运行时与加速
- **缓存**：对相同基因组的评估做记忆化，避免重复求解。
- **代理模型**：若 FEMM 过慢，可用采样设计训练回归模型（如 RBF 或小型神经网络）近似适应度，再用 FEMM 精修精英个体。
- **并行化**：若 FEMM 批处理允许，可将适应度评估分发到多核。

## 下一步
1. 选定网格分辨率并在 `clonalg` 中映射到比特索引，同时生成“可设计区掩膜”（槽内与线圈窗口比特恒定为 0，不参与优化）。可直接调用新函数 `stator_design_domain` 生成 `design_mask`/`slot_mask`。
2. 打样一个几何生成函数：读取比特网格与掩膜，清理模板中可设计区的几何，按比特布置材料，并在求解前复制/旋转到扇区边界。辅助函数 `apply_design_mask` 可以把固定区域自动覆盖为铁（或空气）基底。
3. 用新的包装替换 `myfunc`：解码基因组 → 应用掩膜 → 重建 FEMM 扇区 → 运行转矩/脉动评估 → 返回标量适应度（含可制造性惩罚）。
4. 在少量手工图案上验证：槽区域保持未改动、转矩缩放正确、周期边界正常，然后再运行完整优化。

## 实现代码的建议顺序
1. **定义设计域参数**：在 MATLAB 脚本中填写 `cfg = struct(...)`（内外径、槽窗口半径、槽口张角、网格细分、缓冲角等），调用 `domain = stator_design_domain(cfg);` 确认掩膜尺寸与预期一致。
2. **连接免疫算法基因长度**：将 `nt*nr` 设为基因比特数，按 `domain.design_mask` 的尺寸重塑抗体编码，保持槽/线圈区域在 `apply_design_mask` 中被强制为基底值，不参与优化。
3. **几何生成适配 FEMM**：在新的 FEMM 构建函数里，循环 `design_mask` 的可编辑单元，用 `mi_drawpolygon`/`mi_addblocklabel` 写入对应材料；`slot_mask` 覆盖区则直接放置铜/空气标签，避免被修改。
4. **集成到 `myfunc`**：在计算适应度时，先将比特串传入 `apply_design_mask` 得到完整网格，再映射到 FEMM 几何、求解转矩，最后返回带惩罚项的目标值。
5. **调试与可视化**：在早期迭代中绘制 `design_mask` 和当前基因对应的材料分布热力图，检查槽区不被侵蚀，周期边界单元保持对称。

## `cfg = struct(...)` 的写法与填写指南
- MATLAB 里 `cfg = struct('字段1', 值1, '字段2', 值2, ...)` 会创建一个含命名字段的结构体；字段名用引号包住，字段和值交替出现。
- 设计域脚本期望的字段与含义（与 `stator_design_domain.m` 一致）：
  - 必填：
    - `nr`、`nt`：径向/切向单元数（决定网格分辨率）。
    - `r_inner`、`r_outer`：定子内外半径。
    - `slot_r_inner`、`slot_r_outer`：槽口起止半径（槽口到线圈窗口）。
    - `slot_span_deg`：槽窗口在 15° 扇区内占用的张角。
    - `theta_span_deg`：设计扇区总张角（本方案用 15）。
  - 可选：
    - `coil_keepout_deg`：槽口两侧额外冻结的半角（默认 0，可加宽保护区）。
    - `yoke_buffer_deg`：扇区边界附近的冻结半角，用于周期边界稳定（默认 0）。
- 完整示例（可直接粘贴运行）：
  ```matlab
  cfg = struct('nr', 8, 'nt', 20, ...
               'r_inner', 22, 'r_outer', 40, ...
               'slot_r_inner', 22.5, 'slot_r_outer', 28, ...
               'slot_span_deg', 6, 'theta_span_deg', 15, ...
               'coil_keepout_deg', 1.0, 'yoke_buffer_deg', 0.5);
  domain = stator_design_domain(cfg);
  ```
  上述写法依次给每个字段赋值，等价于逐行写 `cfg.nr = 8; cfg.nt = 20; ...`，但更简洁且不易漏项。
